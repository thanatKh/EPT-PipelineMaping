<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>18 ILI Pipeline Map ‚Äî PTT SRC</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>

<!--
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  HOW TO USE                                          ‚îÇ
  ‚îÇ  Keep data.js and pipeline_map.html in SAME folder.  ‚îÇ
  ‚îÇ  Open via local server (not file://) :               ‚îÇ
  ‚îÇ    python3 -m http.server 8080                       ‚îÇ
  ‚îÇ    ‚Üí http://localhost:8080/pipeline_map.html         ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
-->
<script src="data.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
:root {
  --bg:      #000000;
  --glass:   rgba(28,28,35,0.72);
  --glass2:  rgba(0,40,60,0.88);
  --border:  rgba(255,255,255,0.08);
  --border2: rgba(255,255,255,0.14);
  --text:    #f5f5f7;
  --text2:   rgba(235,235,245,0.60);
  --text3:   rgba(235,235,245,0.28);
  --blue:    #0a84ff;
  --blue2:   #40a9ff;
  --red:     #ff453a;
  --orange:  #ff9f0a;
  --yellow:  #ffd60a;
  --green:   #30d158;
  --teal:    #5ac8fa;
  --purple:  #bf5af2;
  --pink:    #ff375f;
  --blur:    saturate(180%) blur(20px);
  --r:       16px;
  --r-sm:    11px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-font-smoothing:antialiased;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;}

/* TOP BAR */
#topbar{
  position:relative;z-index:100;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:60px;flex-shrink:0;
  background:var(--glass2);backdrop-filter:var(--blur);
  border-bottom:1px solid var(--border2);
  box-shadow:0 1px 0 rgba(255,255,255,.05);
}
#branding{display:flex;align-items:center;gap:10px;min-width:0;flex-shrink:1;}
#logo-img{height:32px;object-fit:contain;flex-shrink:0;}
#brand-text{min-width:0;}
#brand-text .dept{font-size:10px;font-weight:500;color:var(--blue2);letter-spacing:.8px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#brand-text .company{font-size:12.5px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#topbar-center{position:absolute;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none;white-space:nowrap;}
#topbar-center .t1{font-size:13px;font-weight:600;}
#topbar-center .t2{font-size:11px;color:var(--text2);margin-top:1px;}
#kpi-row{display:flex;gap:5px;flex-shrink:0;}
.kpi{display:flex;flex-direction:column;align-items:center;padding:5px 10px;min-width:56px;
     background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;}
.kpi .v{font-size:15px;font-weight:700;letter-spacing:-.5px;line-height:1.1;}
.kpi .l{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
.kpi.red .v{color:var(--red);}.kpi.orange .v{color:var(--orange);}
.kpi.yellow .v{color:var(--yellow);}.kpi.green .v{color:var(--green);}.kpi.blue .v{color:var(--blue2);}

/* ‚îÄ‚îÄ TABLET: hide center title, shrink KPIs ‚îÄ‚îÄ */
@media (max-width:1024px){
  #topbar-center{display:none;}
  .kpi{min-width:48px;padding:4px 8px;}
  .kpi .v{font-size:13px;}
  .kpi .l{font-size:8px;}
  #brand-text .company{max-width:180px;}
}

/* ‚îÄ‚îÄ MOBILE: stack topbar into two rows ‚îÄ‚îÄ */
@media (max-width:640px){
  #topbar{
    height:auto;flex-direction:column;align-items:stretch;
    padding:10px 12px 8px;gap:8px;
  }
  #topbar-row1{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  #topbar-row2{display:flex;align-items:center;justify-content:center;gap:4px;flex-wrap:wrap;padding-bottom:2px;}
  #branding{flex:1;min-width:0;}
  #logo-img{height:28px;}
  #brand-text .dept{font-size:9px;letter-spacing:.4px;}
  #brand-text .company{font-size:11px;max-width:200px;}
  #kpi-row{gap:4px;flex-wrap:wrap;justify-content:center;}
  .kpi{min-width:52px;padding:3px 8px;border-radius:8px;}
  .kpi .v{font-size:13px;}
  .kpi .l{font-size:8px;letter-spacing:.3px;}
  #main{height:calc(100vh - 104px);}
  /* Sidebar starts collapsed on mobile */
  #sidebar{width:0;min-width:0;}
  #sidebar-toggle{left:0;}
  #sidebar-toggle.collapsed{left:0;}
}

/* ‚îÄ‚îÄ SMALL MOBILE: even tighter ‚îÄ‚îÄ */
@media (max-width:380px){
  #brand-text .dept{display:none;}
  #brand-text .company{font-size:10.5px;}
  .kpi{min-width:44px;padding:3px 6px;}
  .kpi .v{font-size:12px;}
}

/* LAYOUT */
#main{display:flex;flex:1;height:calc(100vh - 60px);overflow:hidden;position:relative;}
#map{flex:1;z-index:1;}

/* SIDEBAR */
#sidebar{
  width:280px;min-width:280px;
  background:var(--glass);backdrop-filter:var(--blur);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  transition:width .3s cubic-bezier(.4,0,.2,1),min-width .3s cubic-bezier(.4,0,.2,1);
  z-index:50;
}
#sidebar.collapsed{width:0;min-width:0;}
#sidebar-inner{
  width:280px;padding:14px;display:flex;flex-direction:column;gap:10px;
  height:100%;overflow-y:auto;overflow-x:hidden;
}
#sidebar-inner::-webkit-scrollbar{width:3px;}
#sidebar-inner::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* CARDS */
.card{background:rgba(255,255,255,.035);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 13px;}
.card-title{
  font-size:10px;font-weight:600;color:var(--text2);
  text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;
  display:flex;align-items:center;gap:6px;
}
.card-title::before{content:'';width:2px;height:11px;background:var(--blue);border-radius:2px;flex-shrink:0;}

/* TOGGLE SWITCHES */
.filter-row{
  display:flex;align-items:center;gap:9px;
  font-size:12px;color:var(--text2);cursor:pointer;
  padding:5px 6px;border-radius:8px;margin:-2px -3px;
  transition:background .15s,color .15s;user-select:none;
}
.filter-row:hover{background:rgba(255,255,255,.05);color:var(--text);}
.cb-track{
  width:28px;height:16px;border-radius:8px;
  background:rgba(255,255,255,.12);flex-shrink:0;position:relative;
  transition:background .2s;cursor:pointer;
}
.cb-track.on{background:var(--blue);}
.cb-track::after{
  content:'';position:absolute;top:2px;left:2px;
  width:12px;height:12px;border-radius:6px;background:#fff;
  transition:transform .2s cubic-bezier(.4,0,.2,1);
  box-shadow:0 1px 3px rgba(0,0,0,.4);
}
.cb-track.on::after{transform:translateX(12px);}
.pill{width:8px;height:8px;border-radius:50%;flex-shrink:0;box-shadow:0 0 5px currentColor;}
.pill.red   {background:var(--red);   color:var(--red);}
.pill.orange{background:var(--orange);color:var(--orange);}
.pill.yellow{background:var(--yellow);color:var(--yellow);}
.pill.green {background:var(--green); color:var(--green);}
.pill.teal  {background:var(--teal);  color:var(--teal);}
.pill.pink  {background:var(--pink);  color:var(--pink);border-radius:2px;}
.filter-count{margin-left:auto;font-size:10px;color:var(--text3);}

/* CHIPS */
.chip-row{display:flex;gap:6px;flex-wrap:wrap;}
.chip{
  padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;
  border:1px solid var(--border);color:var(--text2);cursor:pointer;
  transition:all .15s;display:flex;align-items:center;gap:5px;
}
.chip.active{border-color:var(--blue);color:var(--blue2);background:rgba(10,132,255,.12);}
.chip-dot{width:6px;height:6px;border-radius:50%;}

/* SLIDER */
.slider-track{position:relative;height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin:10px 0 4px;}
.slider-fill{position:absolute;left:0;top:0;height:100%;background:var(--blue);border-radius:2px;pointer-events:none;}
input[type=range]{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer;margin:0;}
.slider-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text3);}

/* LAYER PILLS */
.layer-row{display:flex;gap:6px;flex-wrap:wrap;}
.lpill{
  padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;
  border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .2s;
}
.lpill:hover{color:var(--text);border-color:var(--border2);}
.lpill.on{background:rgba(10,132,255,.18);border-color:var(--blue);color:var(--blue2);}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.stat-box{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:8px 10px;}
.stat-box .sv{font-size:18px;font-weight:700;letter-spacing:-.5px;}
.stat-box .sl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-top:1px;}

/* INFO LIST */
.info-row{display:flex;justify-content:space-between;font-size:11px;padding:4px 0;border-bottom:1px solid var(--border);}
.info-row:last-child{border:none;}
.info-row .ik{color:var(--text2);}.info-row .iv{color:var(--text);font-weight:500;}

/* SEARCH */
#search-wrap{position:relative;}
#search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;pointer-events:none;}
#search-input{
  width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);
  border-radius:10px;color:var(--text);padding:8px 11px 8px 32px;
  font-size:12px;outline:none;font-family:'DM Sans',sans-serif;transition:border-color .2s,background .2s;
}
#search-input:focus{border-color:var(--blue);background:rgba(10,132,255,.06);}
#search-results{max-height:140px;overflow-y:auto;margin-top:6px;}
.sr-item{padding:6px 8px;font-size:11px;cursor:pointer;border-radius:8px;border-bottom:1px solid var(--border);transition:background .1s;}
.sr-item:hover{background:rgba(255,255,255,.05);}

/* TOGGLE BTN */
#sidebar-toggle{
  position:absolute;left:280px;top:50%;transform:translateY(-50%);
  z-index:200;width:20px;height:44px;
  background:var(--glass);backdrop-filter:var(--blur);
  border:1px solid var(--border);border-left:none;
  border-radius:0 10px 10px 0;color:var(--text2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:10px;transition:left .3s cubic-bezier(.4,0,.2,1);
}
#sidebar-toggle.collapsed{left:0;}
#sidebar-toggle:hover{color:var(--text);}

/* DETAIL PANEL */
#detail-panel{
  position:absolute;bottom:24px;right:24px;width:292px;
  background:var(--glass2);backdrop-filter:var(--blur);
  border:1px solid var(--border2);border-radius:var(--r);
  padding:16px;z-index:500;display:none;
  box-shadow:0 24px 48px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.07);
  animation:slideUp .2s cubic-bezier(.4,0,.2,1);
  max-height:60vh;overflow-y:auto;
}
@media(max-width:640px){
  #detail-panel{left:12px;right:12px;bottom:12px;width:auto;}
}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
#detail-panel .dp-close{
  position:absolute;top:12px;right:13px;
  background:rgba(255,255,255,.08);border:none;color:var(--text2);
  width:22px;height:22px;border-radius:11px;font-size:11px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;
}
#detail-panel .dp-close:hover{background:rgba(255,59,48,.2);color:var(--red);}
#dp-title{font-size:13px;font-weight:600;margin-bottom:12px;padding-right:28px;}
.dp-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:4px 0;border-bottom:1px solid var(--border);}
.dp-row:last-of-type{border:none;}
.dp-row .lbl{color:var(--text2);}.dp-row .val{color:var(--text);font-weight:500;text-align:right;}
.dp-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;margin-top:10px;}
.depth-bar-bg{background:rgba(255,255,255,.08);border-radius:3px;height:5px;width:100%;overflow:hidden;}
.depth-bar-fill{height:100%;border-radius:3px;transition:width .4s cubic-bezier(.4,0,.2,1);}

/* LEAFLET OVERRIDES */
.leaflet-tooltip{
  background:var(--glass2)!important;backdrop-filter:blur(16px)!important;
  border:1px solid var(--border2)!important;color:var(--text)!important;
  font-size:12px!important;font-family:'DM Sans',sans-serif!important;
  border-radius:10px!important;padding:9px 12px!important;
  box-shadow:0 8px 24px rgba(0,0,0,.5)!important;
}
.leaflet-tooltip-top::before{border-top-color:var(--border2)!important;}
.leaflet-control-zoom{border:1px solid var(--border)!important;border-radius:12px!important;overflow:hidden;backdrop-filter:var(--blur);}
.leaflet-control-zoom a{background:var(--glass2)!important;color:var(--text)!important;border-bottom:1px solid var(--border)!important;width:30px!important;height:30px!important;line-height:30px!important;font-size:16px!important;}
.leaflet-control-zoom a:hover{background:rgba(255,255,255,.1)!important;}
.leaflet-bar{border:none!important;}.leaflet-control-attribution{display:none;}
.pipe-label{
  background:var(--glass2);backdrop-filter:blur(12px);
  border:1px solid var(--border2);border-radius:8px;
  padding:3px 9px;font-size:11px;font-weight:600;
  color:var(--blue2);white-space:nowrap;font-family:'DM Sans',sans-serif;
}

/* LEGEND */
/* MEASURE TOOL */
#measure-bar{
  position:absolute;top:70px;left:50%;transform:translateX(-50%);
  z-index:600;display:none;align-items:center;gap:10px;
  background:var(--glass2);backdrop-filter:var(--blur);
  border:1px solid var(--border2);border-radius:30px;
  padding:8px 16px;font-size:12px;color:var(--text2);
  box-shadow:0 8px 24px rgba(0,0,0,.5);white-space:nowrap;
  animation:slideDown .2s cubic-bezier(.4,0,.2,1);
}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
#measure-bar.active{display:flex;}
.measure-dot{width:7px;height:7px;border-radius:50%;background:var(--blue);box-shadow:0 0 6px var(--blue);flex-shrink:0;}
#measure-result{font-size:14px;font-weight:700;color:var(--blue2);min-width:110px;text-align:center;}
#measure-clear{
  background:rgba(255,255,255,.08);border:none;color:var(--text2);
  padding:3px 10px;border-radius:20px;font-size:11px;cursor:pointer;
  font-family:'DM Sans',sans-serif;transition:all .15s;
}
#measure-clear:hover{background:rgba(255,59,48,.2);color:var(--red);}
#map.measuring,#map.measuring .leaflet-container{cursor:crosshair!important;}

.legend-box{
  background:var(--glass2);backdrop-filter:var(--blur);
  border:1px solid var(--border);border-radius:var(--r-sm);
  padding:12px 14px;font-family:'DM Sans',sans-serif;min-width:170px;
}
.legend-title{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:9px;}
.leg-row{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text);margin-bottom:5px;}
.leg-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.leg-line{width:18px;height:3px;border-radius:2px;flex-shrink:0;}
.leg-sq{width:9px;height:9px;border-radius:2px;flex-shrink:0;}
.legend-note{font-size:9.5px;color:var(--text3);margin-top:7px;padding-top:7px;border-top:1px solid var(--border);line-height:1.5;}
</style>
</head>
<body>

<div id="topbar">
  <div id="topbar-row1">
    <div id="branding">
      <img id="logo-img" src="https://uppic.cloud/ib/mVAAyQbB1nqbsyF_1772152846.png"
           alt="PTT OR" onerror="this.style.display='none'">
      <div id="brand-text">
        <div class="dept">Central and Eastern Engineering and Maintenance Division</div>
        <div class="company">PTT Oil and Retail Business Public Company Limited</div>
      </div>
    </div>
    <div id="topbar-center">
      <div class="t1">‚Äé </div>
      <div class="t2">In-Line Inspection ‚Äî Anomaly Map 18‚Ä≥ T61 ‚Üí Sea Berth &nbsp;¬∑&nbsp; 2.7 km &nbsp;¬∑&nbsp; 22‚Äì23 Nov 2025</div>
    </div>
  </div>
  <div id="topbar-row2">
    <div id="kpi-row">
      <div class="kpi red">   <div class="v">1</div>     <div class="l">‚â§1 yr</div></div>
      <div class="kpi orange"><div class="v">2</div>     <div class="l">&lt;10 yr</div></div>
      <div class="kpi yellow"><div class="v">2,012</div> <div class="l">&gt;10 yr</div></div>
      <div class="kpi blue">  <div class="v">2,014</div> <div class="l">Metal Loss</div></div>
      <div class="kpi blue">  <div class="v">1,139</div> <div class="l">Laminations</div></div>
      <div class="kpi green"> <div class="v">0</div>     <div class="l">ERF ‚â• 1.0</div></div>
    </div>
  </div>
</div>

<div id="main">
  <div id="sidebar">
    <div id="sidebar-inner">

      <div class="card">
        <div class="card-title">Search</div>
        <div id="search-wrap">
          <span id="search-icon">‚åï</span>
          <input id="search-input" type="text" placeholder="Feature ID, distance, type‚Ä¶">
        </div>
        <div id="search-results"></div>
      </div>

      <div class="card">
        <div class="card-title">Repair Priority</div>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <label class="filter-row" data-repair="<=1yr">
            <div class="cb-track on"></div><span class="pill red"></span>
            <span>Repair ‚â§ 1 year</span><span class="filter-count">1</span>
          </label>
          <label class="filter-row" data-repair="5-7yr">
            <div class="cb-track on"></div><span class="pill orange"></span>
            <span>Repair 5‚Äì7 years</span><span class="filter-count">1</span>
          </label>
          <label class="filter-row" data-repair="7-10yr">
            <div class="cb-track on"></div><span class="pill yellow"></span>
            <span>Repair 7‚Äì10 years</span><span class="filter-count">1</span>
          </label>
          <label class="filter-row" data-repair=">10yr">
            <div class="cb-track on"></div><span class="pill green"></span>
            <span>Repair &gt; 10 years</span><span class="filter-count">2,012</span>
          </label>
          <label class="filter-row" data-repair="monitored">
            <div class="cb-track on"></div><span class="pill teal"></span>
            <span>Monitored</span><span class="filter-count">0</span>
          </label>
          <label class="filter-row" id="dent-row">
            <div class="cb-track on" id="dent-track"></div><span class="pill pink"></span>
            <span>Dents</span><span class="filter-count">1</span>
          </label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Surface Location</div>
        <div class="chip-row">
          <div class="chip active" data-loc="External"><span class="chip-dot" style="background:var(--orange)"></span>External</div>
          <div class="chip active" data-loc="Internal"><span class="chip-dot" style="background:var(--blue2)"></span>Internal</div>
          <div class="chip active" data-loc="Middle">  <span class="chip-dot" style="background:var(--purple)"></span>Mid-wall</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Min Depth ‚Äî <span id="depth-val" style="color:var(--blue2)">0</span>% WT</div>
        <div class="slider-track">
          <div class="slider-fill" id="slider-fill" style="width:0%"></div>
          <input type="range" id="depth-slider" min="0" max="80" value="0" step="5">
        </div>
        <div class="slider-labels"><span>0%</span><span>20%</span><span>40%</span><span>60%</span><span>80%</span></div>
      </div>

      <div class="card">
        <div class="card-title">Map Layers</div>
        <div class="layer-row">
          <button class="lpill on" id="btn-sat"   >Satellite</button>
          <button class="lpill"    id="btn-street">Street</button>
          <button class="lpill on" id="btn-route" >Pipeline</button>
          <button class="lpill on" id="btn-valves">Valves</button>
        </div>
        <div style="margin-top:8px;">
          <button class="lpill" id="btn-measure" style="width:100%;justify-content:center;display:flex;gap:6px;align-items:center;">
            <span>üìè</span> Measure Distance
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Live Statistics</div>
        <div class="stat-grid">
          <div class="stat-box"><div class="sv" id="stat-visible">‚Äî</div><div class="sl">Visible</div></div>
          <div class="stat-box"><div class="sv" id="stat-deepest" style="color:var(--red)">‚Äî</div><div class="sl">Max Depth</div></div>
          <div class="stat-box"><div class="sv" id="stat-ext" style="color:var(--orange)">‚Äî</div><div class="sl">External</div></div>
          <div class="stat-box"><div class="sv" id="stat-int" style="color:var(--blue2)">‚Äî</div><div class="sl">Internal</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Pipeline Info</div>
        <div class="info-row"><span class="ik">Code</span>       <span class="iv">18T64T61</span></div>
        <div class="info-row"><span class="ik">OD / WT</span>    <span class="iv">18‚Ä≥ / 9.5 mm</span></div>
        <div class="info-row"><span class="ik">MAOP / DP</span>  <span class="iv">10.3 / 14.3 Bar</span></div>
        <div class="info-row"><span class="ik">Installed</span>  <span class="iv">1975 ¬∑ 50 years</span></div>
        <div class="info-row"><span class="ik">Standard</span>   <span class="iv">API 579 / B31G</span></div>
        <div class="info-row"><span class="ik">Contractor</span> <span class="iv">PIPECARE DMCC</span></div>
        <div class="info-row" style="border:none">
          <span style="font-size:11px;color:var(--green);font-weight:600;">‚úì Fit to operate to 2030</span>
        </div>
      </div>

    </div>
  </div>

  <div id="map"></div>
</div>

<button id="sidebar-toggle">‚óÄ</button>

<!-- MEASURE BAR -->
<div id="measure-bar">
  <span class="measure-dot"></span>
  <span id="measure-status">Click first point on the map</span>
  <span id="measure-result" style="display:none"></span>
  <button id="measure-clear">‚úï Clear</button>
</div>

<div id="detail-panel">
  <button class="dp-close" onclick="document.getElementById('detail-panel').style.display='none'">‚úï</button>
  <div id="dp-title"></div>
  <div id="dp-content"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA comes from data.js  (ANOMALIES, DENTS, ROUTE, REFS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const map = L.map('map',{zoomControl:true,preferCanvas:true}).setView([13.1058,100.876],15);
const tiles = {
  sat:    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}),
  street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19})
};
tiles.sat.addTo(map);
let activeTile = 'sat';

// Route
const routePts = ROUTE.map(p=>[p.lat,p.lon]);
let routeLine  = L.polyline(routePts,{color:'#0a84ff',weight:4,opacity:.85}).addTo(map);
let routeGlow  = L.polyline(routePts,{color:'#0a84ff',weight:14,opacity:.06}).addTo(map);
const mkLbl = t => L.divIcon({html:`<div class="pipe-label">${t}</div>`,className:'',iconAnchor:[0,10]});
L.marker(routePts[0],                {icon:mkLbl('üè≠ T61 Launch')}).addTo(map);
L.marker(routePts[routePts.length-1],{icon:mkLbl('‚öì Sea Berth')}).addTo(map);

// Valves
const valveIco = L.divIcon({
  html:`<div style="width:10px;height:10px;background:#ffd60a;border:1.5px solid rgba(0,0,0,.5);border-radius:2px;box-shadow:0 0 8px rgba(255,214,10,.5);"></div>`,
  iconSize:[10,10],iconAnchor:[5,5],className:''
});
let valveLayers=[];
REFS.forEach(r=>{
  const m=L.marker([r.lat,r.lon],{icon:valveIco})
    .bindTooltip(`<b style="color:#ffd60a">${r.comment||'Valve'}</b><br><span style="opacity:.6">${r.dist.toFixed(0)} m</span>`,{direction:'top'});
  valveLayers.push(m); m.addTo(map);
});

// Colour helpers
const RCOL={'<=1yr':'#ff453a','5-7yr':'#ff9f0a','7-10yr':'#ffd60a','>10yr':'#30d158','monitored':'#5ac8fa'};
const repairColor = a => a.type==='dent smooth'?'#ff375f':(RCOL[a.repair||'>10yr']||'#30d158');
const depthColor  = d => d>=60?'#ff453a':d>=40?'#ff9f0a':d>=20?'#ffd60a':'#30d158';
const repairLabel = r => ({'<=1yr':'üî¥ Repair ‚â§ 1 year','5-7yr':'üü† Repair 5‚Äì7 years',
                           '7-10yr':'üü° Repair 7‚Äì10 years','>10yr':'üü¢ Repair > 10 years',
                           'monitored':'ü©µ Monitored'}[r]||r);

function makeTooltip(a,col){
  const d=a.depth;
  const bar=d?`<div style="background:rgba(255,255,255,.1);border-radius:2px;height:4px;width:100%;margin:4px 0;"><div style="height:100%;width:${Math.min(d,100)}%;background:${depthColor(d)};border-radius:2px;"></div></div>`:'';
  return `<div style="min-width:175px;font-family:'DM Sans',sans-serif;">
    <div style="font-weight:600;font-size:13px;color:${col};margin-bottom:2px;">#${a.id}</div>
    <div style="font-size:11px;opacity:.6;margin-bottom:4px;">${(+a.dist).toFixed(1)} m ¬∑ ${a.location}</div>
    ${d?`<div style="color:${depthColor(d)};font-size:14px;font-weight:700;">${d}% WT</div>${bar}`:''}
    ${a.erf?`<div style="font-size:11px;opacity:.6;">ERF ${(+a.erf).toFixed(3)}</div>`:''}
    <div style="font-size:11px;margin-top:4px;">${repairLabel(a.repair||'>10yr')}</div>
  </div>`;
}

function showDetail(a,col){
  document.getElementById('dp-title').innerHTML=
    `<span style="color:${col}">#${a.id}</span>&nbsp;`+
    `<span style="font-weight:400;color:var(--text2);font-size:11px;">${a.type||'Corrosion'}</span>`;
  const d=a.depth;
  const barHtml=d?`<div style="margin:8px 0 6px;">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-bottom:4px;">
      <span>Wall Loss</span><span style="color:${depthColor(d)};font-weight:600;">${d}% WT</span></div>
    <div class="depth-bar-bg"><div class="depth-bar-fill" style="width:${Math.min(d,100)}%;background:${depthColor(d)};"></div></div>
  </div>`:'';
  const rows=[
    ['Distance',(+a.dist).toFixed(2)+' m'],['Surface',a.location||''],
    ['Classification',a.dim||''],['Orientation',a.orient||''],
    ['WT',(+(a.wt||0)).toFixed(2)+' mm'],['Axial',(a.axLen||0)+' mm'],
    ['Width',(a.width||0)+' mm'],['Depth mm',a.depthMm?(+(a.depthMm)).toFixed(2)+' mm':''],
    ['ERF',a.erf?(+(a.erf)).toFixed(3):''],['Altitude',(+(a.alt||0)).toFixed(2)+' m'],
    ['GPS',(+a.lat).toFixed(6)+', '+(+a.lon).toFixed(6)],
  ].filter(([,v])=>v&&v!=='0.00 mm'&&v!=='0 mm'&&v!=='0');
  document.getElementById('dp-content').innerHTML=
    barHtml+
    rows.map(([l,v])=>`<div class="dp-row"><span class="lbl">${l}</span><span class="val">${v}</span></div>`).join('')+
    `<div><span class="dp-badge" style="background:${col}1a;color:${col};border:1px solid ${col}44;">${repairLabel(a.repair||'>10yr')}</span></div>`+
    (a.comment&&a.comment!=='None'?`<div style="margin-top:8px;font-size:10.5px;color:var(--text3);font-style:italic;">${a.comment}</div>`:'');
  document.getElementById('detail-panel').style.display='block';
  map.panTo([a.lat,a.lon]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Z-ORDER FIX ‚Äî HOW IT WORKS
//
//  Leaflet canvas renders layers in the exact order they were
//  added to the map with .addTo().  Last added = drawn on TOP.
//
//  Rule:  most points  ‚Üí added FIRST  ‚Üí painted at the BOTTOM
//         fewest points ‚Üí added LAST   ‚Üí painted ON TOP
//
//  So we create each priority group as its own LayerGroup and
//  call addTo(map) in this sequence:
//
//    >10yr    (2,012 pts)  ‚Üê addTo 1st ‚Üí sits at the BOTTOM
//    monitored             ‚Üê addTo 2nd
//    7-10yr   (    1 pt)   ‚Üê addTo 3rd
//    5-7yr    (    1 pt)   ‚Üê addTo 4th
//    <=1yr    (    1 pt)   ‚Üê addTo 5th ‚Üí sits ON TOP of green
//    dents    (    1 pt)   ‚Üê addTo 6th ‚Üí topmost of all
//
//  When rebuildMarkers() runs, each marker is inserted into its
//  correct bucket ‚Äî the z-order is preserved because the buckets
//  themselves never change their stack position.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const RENDER_ORDER = ['>10yr', 'monitored', '7-10yr', '5-7yr', '<=1yr'];
const pLayers = {};
RENDER_ORDER.forEach(k => {
  pLayers[k] = L.layerGroup();
  pLayers[k].addTo(map);   // ORDER MATTERS ‚Äî do not rearrange
});
let dentLayer = L.layerGroup().addTo(map);  // added last = topmost

DENTS.forEach(d=>{
  const m=L.circleMarker([d.lat,d.lon],{radius:11,color:'#ff375f',fillColor:'#ff375f',fillOpacity:.9,weight:2});
  m.bindTooltip(`<div style="font-family:'DM Sans',sans-serif;min-width:160px;">
    <div style="font-weight:600;color:#ff375f;font-size:13px;">üî∫ DENT #${d.id}</div>
    <div style="color:#ff453a;font-weight:600;margin:3px 0;">‚ö† Repair by Nov 2026</div>
    <div style="font-size:11px;opacity:.6;">${(+d.dist).toFixed(1)} m ¬∑ ${d.depth}% OD</div>
    <div style="font-size:10px;opacity:.5;margin-top:3px;font-style:italic;">${d.comment}</div>
  </div>`,{direction:'top',sticky:true});
  m.on('click',()=>showDetail(d,'#ff375f'));
  m.addTo(dentLayer);
});

// Filter state
const activeRepair   = new Set(['>10yr','monitored','7-10yr','5-7yr','<=1yr']);
const activeLocation = new Set(['External','Internal','Middle']);
let minDepth=0;

function rebuildMarkers(){
  RENDER_ORDER.forEach(k=>pLayers[k].clearLayers());
  let vis=0,maxD=0,ext=0,intC=0;
  ANOMALIES.forEach(a=>{
    const rk=a.repair||'>10yr';
    if(!activeRepair.has(rk))           return;
    if(!activeLocation.has(a.location)) return;
    if((a.depth||0)<minDepth)           return;
    const col=repairColor(a);
    const r=Math.max(4,Math.min(13,(a.depth||10)/6.5));
    const c=L.circleMarker([a.lat,a.lon],{radius:r,color:col,fillColor:col,fillOpacity:.7,weight:1});
    c.bindTooltip(makeTooltip(a,col),{sticky:true,direction:'top',opacity:1});
    c.on('click',()=>showDetail(a,col));
    pLayers[rk].addLayer(c);
    vis++;if((a.depth||0)>maxD)maxD=a.depth||0;
    if(a.location==='External')ext++;else if(a.location==='Internal')intC++;
  });

  // ‚îÄ‚îÄ CRITICAL Z-ORDER ENFORCEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // clearLayers() + addLayer() does NOT reset Leaflet's canvas
  // paint order ‚Äî the shared canvas repaints layers in the order
  // their LayerGroup was last mounted on the map.
  //
  // Fix: after every rebuild, remove then re-add the critical
  // (low-count) layers so they are mounted LAST = painted ON TOP.
  //
  //   >10yr stays mounted first ‚Üí drawn at the BOTTOM (buried)
  //   <=1yr re-mounted last     ‚Üí drawn ON TOP (always visible)
  //
  const bringToFront = ['>10yr','monitored','7-10yr','5-7yr','<=1yr'];
  bringToFront.forEach(k => {
    map.removeLayer(pLayers[k]);
    pLayers[k].addTo(map);   // re-mount in ascending criticality
  });
  // Dents always topmost
  map.removeLayer(dentLayer);
  dentLayer.addTo(map);
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  document.getElementById('stat-visible').textContent=vis.toLocaleString();
  document.getElementById('stat-deepest').textContent=maxD.toFixed(1)+'%';
  document.getElementById('stat-ext').textContent=ext.toLocaleString();
  document.getElementById('stat-int').textContent=intC.toLocaleString();
}
rebuildMarkers();

// Filter controls
document.querySelectorAll('.filter-row[data-repair]').forEach(row=>{
  const key=row.dataset.repair, track=row.querySelector('.cb-track');
  row.addEventListener('click',()=>{
    const on=track.classList.toggle('on');
    on?activeRepair.add(key):activeRepair.delete(key);
    rebuildMarkers();
  });
});
document.querySelectorAll('.chip[data-loc]').forEach(chip=>{
  chip.addEventListener('click',()=>{
    chip.classList.toggle('active');
    const loc=chip.dataset.loc;
    chip.classList.contains('active')?activeLocation.add(loc):activeLocation.delete(loc);
    rebuildMarkers();
  });
});
document.getElementById('depth-slider').addEventListener('input',e=>{
  minDepth=+e.target.value;
  document.getElementById('depth-val').textContent=minDepth;
  document.getElementById('slider-fill').style.width=(minDepth/80*100)+'%';
  rebuildMarkers();
});
document.getElementById('dent-row').addEventListener('click',()=>{
  const t=document.getElementById('dent-track');
  t.classList.toggle('on');
  t.classList.contains('on')?dentLayer.addTo(map):map.removeLayer(dentLayer);
});

// Layer buttons
document.getElementById('btn-sat').addEventListener('click',function(){
  if(activeTile!=='sat'){map.removeLayer(tiles.street);tiles.sat.addTo(map);activeTile='sat';this.classList.add('on');document.getElementById('btn-street').classList.remove('on');}
});
document.getElementById('btn-street').addEventListener('click',function(){
  if(activeTile!=='street'){map.removeLayer(tiles.sat);tiles.street.addTo(map);activeTile='street';this.classList.add('on');document.getElementById('btn-sat').classList.remove('on');}
});
document.getElementById('btn-route').addEventListener('click',function(){
  map.hasLayer(routeLine)?(map.removeLayer(routeLine),map.removeLayer(routeGlow),this.classList.remove('on')):(routeLine.addTo(map),routeGlow.addTo(map),this.classList.add('on'));
});
document.getElementById('btn-valves').addEventListener('click',function(){
  this.classList.contains('on')?(valveLayers.forEach(v=>map.removeLayer(v)),this.classList.remove('on')):(valveLayers.forEach(v=>v.addTo(map)),this.classList.add('on'));
});

// Search
document.getElementById('search-input').addEventListener('input',function(){
  const q=this.value.trim().toLowerCase(),sr=document.getElementById('search-results');
  sr.innerHTML='';if(!q)return;
  ANOMALIES.filter(a=>a.id.toLowerCase().includes(q)||String(Math.round(a.dist)).includes(q)||(a.type||'').toLowerCase().includes(q)).slice(0,10).forEach(a=>{
    const col=repairColor(a),d=document.createElement('div');
    d.className='sr-item';
    d.innerHTML=`<b style="color:${col}">#${a.id}</b><span style="opacity:.5"> ¬∑ ${(+a.dist).toFixed(1)}m ¬∑ ${a.location} ¬∑ </span><b style="color:${depthColor(a.depth||0)}">${a.depth||'?'}%</b>`;
    d.onclick=()=>{map.setView([a.lat,a.lon],19);showDetail(a,col);sr.innerHTML='';this.value='#'+a.id;};
    sr.appendChild(d);
  });
});

// Sidebar toggle
const sb=document.getElementById('sidebar'),tb=document.getElementById('sidebar-toggle');
tb.addEventListener('click',()=>{
  const c=sb.classList.toggle('collapsed');
  tb.classList.toggle('collapsed',c);
  tb.textContent=c?'‚ñ∂':'‚óÄ';
  setTimeout(()=>map.invalidateSize(),310);
});

// Legend
const legend=L.control({position:'bottomright'});
legend.onAdd=()=>{
  const d=L.DomUtil.create('div','legend-box');
  d.innerHTML=`<div class="legend-title">Anomaly Legend</div>
    <div class="leg-row"><span class="leg-dot" style="background:#ff453a;box-shadow:0 0 5px #ff453a66;"></span>Repair ‚â§ 1 year</div>
    <div class="leg-row"><span class="leg-dot" style="background:#ff9f0a;box-shadow:0 0 5px #ff9f0a66;"></span>Repair 5‚Äì7 years</div>
    <div class="leg-row"><span class="leg-dot" style="background:#ffd60a;box-shadow:0 0 5px #ffd60a66;"></span>Repair 7‚Äì10 years</div>
    <div class="leg-row"><span class="leg-dot" style="background:#30d158;box-shadow:0 0 5px #30d15866;"></span>Repair &gt; 10 years</div>
    <div class="leg-row"><span class="leg-dot" style="background:#5ac8fa;box-shadow:0 0 5px #5ac8fa66;"></span>Monitored</div>
    <div class="leg-row"><span class="leg-sq"  style="background:#ff375f;box-shadow:0 0 5px #ff375f66;"></span>Dent</div>
    <div class="leg-row"><span class="leg-sq"  style="background:#ffd60a;box-shadow:0 0 5px #ffd60a66;"></span>Valve</div>
    <div class="leg-row"><span class="leg-line"style="background:#0a84ff;box-shadow:0 0 5px #0a84ff66;"></span>Pipeline Route</div>
    <div class="legend-note">Marker size ‚àù depth % WT<br>Click any marker for details</div>`;
  return d;
};
legend.addTo(map);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MEASURE DISTANCE TOOL
//
//  Click to place point A ‚Üí click again for point B ‚Üí shows distance.
//  Supports multi-segment polylines: keep clicking to chain segments.
//  Click "‚úï Clear" or press Escape to reset.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let measuring      = false;
let measurePts     = [];       // array of L.LatLng
let measureMarkers = [];       // dot markers
let measureLines   = [];       // polyline segments
let measureLabels  = [];       // distance label markers
let totalDist      = 0;

const measureBar    = document.getElementById('measure-bar');
const measureStatus = document.getElementById('measure-status');
const measureResult = document.getElementById('measure-result');
const btnMeasure    = document.getElementById('btn-measure');
const btnMeasureClear = document.getElementById('measure-clear');

// Haversine formula ‚Äî accurate great-circle distance in metres
function haversine(a, b) {
  const R = 6371000;
  const œÜ1 = a.lat * Math.PI/180, œÜ2 = b.lat * Math.PI/180;
  const ŒîœÜ = (b.lat - a.lat) * Math.PI/180;
  const ŒîŒª = (b.lng - a.lng) * Math.PI/180;
  const s   = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
}

function formatDist(m) {
  return m >= 1000
    ? (m/1000).toFixed(3) + ' km'
    : Math.round(m) + ' m';
}

function measureDotIcon(label, color='#0a84ff') {
  return L.divIcon({
    html: `<div style="
      width:12px;height:12px;border-radius:50%;
      background:${color};border:2px solid #fff;
      box-shadow:0 0 8px ${color}99;
    "></div>`,
    iconSize:[12,12], iconAnchor:[6,6], className:''
  });
}

function measureLabelIcon(text) {
  return L.divIcon({
    html: `<div style="
      background:rgba(14,14,20,.88);backdrop-filter:blur(8px);
      border:1px solid rgba(10,132,255,.5);border-radius:6px;
      padding:2px 8px;font-size:11px;font-weight:600;
      color:#40a9ff;white-space:nowrap;font-family:'DM Sans',sans-serif;
      transform:translateX(-50%) translateY(-24px);
    ">${text}</div>`,
    iconSize:[0,0], iconAnchor:[0,0], className:''
  });
}

function clearMeasure() {
  measurePts = []; totalDist = 0;
  measureMarkers.forEach(m => map.removeLayer(m));
  measureLines.forEach(l => map.removeLayer(l));
  measureLabels.forEach(l => map.removeLayer(l));
  measureMarkers = []; measureLines = []; measureLabels = [];
  measureStatus.textContent = 'Click first point on the map';
  measureResult.style.display = 'none';
  measureStatus.style.display = '';
}

function stopMeasuring() {
  measuring = false;
  btnMeasure.classList.remove('on');
  document.getElementById('map').classList.remove('measuring');
  measureBar.classList.remove('active');
  map.off('click', onMeasureClick);
  clearMeasure();
}

function onMeasureClick(e) {
  const pt = e.latlng;
  measurePts.push(pt);

  // Place a dot marker at each point
  const isFirst = measurePts.length === 1;
  const dot = L.marker(pt, {
    icon: measureDotIcon(isFirst ? '#30d158' : '#0a84ff'),
    zIndexOffset: 9000
  }).addTo(map);
  measureMarkers.push(dot);

  if (measurePts.length === 1) {
    measureStatus.textContent = 'Click second point ‚Äî or keep clicking to chain';
    return;
  }

  // Draw segment line from previous point to this one
  const prev = measurePts[measurePts.length - 2];
  const segDist = haversine(prev, pt);
  totalDist += segDist;

  const line = L.polyline([prev, pt], {
    color:'#0a84ff', weight:2.5, opacity:.9,
    dashArray:'6 4'
  }).addTo(map);
  measureLines.push(line);

  // Midpoint label showing this segment's distance
  const mid = L.latLng((prev.lat+pt.lat)/2, (prev.lng+pt.lng)/2);
  const segLabel = L.marker(mid, {
    icon: measureLabelIcon(formatDist(segDist)),
    zIndexOffset: 9001
  }).addTo(map);
  measureLabels.push(segLabel);

  // Update bar
  if (measurePts.length === 2) {
    // First full segment ‚Äî show result area
    measureStatus.style.display = 'none';
    measureResult.style.display = '';
  }
  measureResult.textContent = measurePts.length > 2
    ? `Total: ${formatDist(totalDist)}`
    : formatDist(totalDist);

  // Update last dot colour to blue (not green) since it's a midpoint now
  if (measurePts.length > 2) {
    const prev_dot = measureMarkers[measurePts.length - 2];
    map.removeLayer(prev_dot);
    const new_dot = L.marker(prev, {
      icon: measureDotIcon('#0a84ff'),
      zIndexOffset: 9000
    }).addTo(map);
    measureMarkers[measurePts.length - 2] = new_dot;
  }
}

// Toggle measure mode
btnMeasure.addEventListener('click', () => {
  if (measuring) {
    stopMeasuring();
  } else {
    measuring = true;
    btnMeasure.classList.add('on');
    document.getElementById('map').classList.add('measuring');
    measureBar.classList.add('active');
    clearMeasure();
    map.on('click', onMeasureClick);
  }
});

// Clear button
btnMeasureClear.addEventListener('click', e => {
  e.stopPropagation();
  clearMeasure();
});

// Escape key exits measure mode
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && measuring) stopMeasuring();
});

// ‚îÄ‚îÄ Dynamic topbar height (mobile two-row layout) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fixMapHeight() {
  const tbH = document.getElementById('topbar').offsetHeight;
  document.getElementById('main').style.height = `calc(100vh - ${tbH}px)`;
  map.invalidateSize();
}
fixMapHeight();
window.addEventListener('resize', fixMapHeight);

map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

</script>
</body>
</html>
